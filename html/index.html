<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Dope</title>

    <style>
        .error {
            color: #8b0000;
            font-style: italic;
            font-weight: bold;
            text-align: center;
        }
        #capPositionX, #capPositionY {
            width: 20px;
        }
    </style>

    <script src="js/flapjax-2.1.js"></script>
    <script src="js/jquery-1.7.1.min.js"></script>
    <script>
        function loader() {
            function makeLoginRequest(name) {
                return {
                    url: '/login/', fields: {"playerName": JSON.stringify(name)},
                    request: "get", response: 'json'
                }
            }

            function makeActRequest(sessionId, option) {
                console.dir(sessionId);
                console.dir(option);
                // TODO integers are make into strings with JSON.stringify. The server cannot handle this.
                var optionString = "{\"TakeACap\":[{\"Some\":[{\"Position\":[2,3]}]}]}";
                return {
                    url: '/play/', fields: {sessionId: JSON.stringify(sessionId), option: optionString},
                    request: "get", response: 'json'
                }
            }

            function showLoginView() {
                $("#gameView").hide();
                $("#loginView").show();
            }

            function setupLoginView() {
                var loginNameB = extractValueB("loginName");
                var loginRequestsE = $E('loginButton', 'click')
                        .snapshotE(loginNameB)
                        .mapE(makeLoginRequest);
                var loginResponseE = getWebServiceObjectE(loginRequestsE);

                var loginDataE = loginResponseE
                        .filterE(function (r) {return r.OK != undefined})
                        .mapE(function (r) {return r.OK});
                var errorsE = loginResponseE
                        .filterE(function (r) {return r.Failure != undefined})
                        .mapE(function (r) {return Object.keys(r.Failure[0])[0]});
                insertDomE(errorsE, "loginErrorText");
                $("#loginName").focus();
                return loginDataE;
            }

            function showPlayView(data) {
                $("#loginView").hide();
                $("#gameView").show();


                var capPositionX = extractValueB("capPositionX");
                var capPositionY = extractValueB("capPositionY");

                function makeCapRequest() {
                    var option = {TakeACap:[{Some:[{Position: [capPositionX.valueNow(), capPositionY.valueNow()]}]}]};
                    return makeActRequest(sessionIdB.valueNow(), option);
                }
                var capRequestsE = $E('takeACapButton', 'click')
                        .mapE(makeCapRequest);

                var responsesE = getWebServiceObjectE(capRequestsE);
                var okE = responsesE
                        .filterE(function (r) {return r.OK != undefined})
                        .mapE(function (r) {return r.OK});
                var failureE = responsesE
                        .filterE(function (r) {return r.Failure != undefined})
                        .mapE(function (r) {return Object.keys(r.Failure[0])[0]});


                var okB = okE.startsWith(data);
                var sessionIdB = okB.liftB(function (data) {return data[0]});
                var playerB = okB.liftB(function (data) {return data[1].PlayerIntrospection._player});
                var optionsB = okB.liftB(function (data) {return data[2]});

                insertDomB(optionsB.liftB(JSON.stringify), "optionsText");
            }

            var loginDataE = setupLoginView();
            showLoginView();

            loginDataE.mapE(function (data) {
                console.dir(data);
                showPlayView(data);
            });

         }
    </script>

</head>
<body onload="loader()" id="body">

<div id="loginView">
    <fieldset>
        <legend>Login:</legend>
        <div><label for="loginName">Name: </label><input id="loginName" type="text"></div>
        <div><button id="loginButton">Login</button></div>
        <div class="options"><span id="optionsText"></span></div>
        <div class="error"><span id="loginErrorText"></span></div>
    </fieldset>
</div>

<div id="gameView">
    <h1>World of Dope</h1>

    <fieldset>
        <legend>Act:</legend>
        <div>Take a cap to
            (<input id="capPositionX" type="text">, <input id="capPositionY" type="text">)
            <button id="takeACapButton">Do it</button>
        </div>

        <div class="error"><span id="playErrorText"></span></div>
    </fieldset>

    <div id="playerView">
        <table id="playerTable">
            <tr><td>Name: </td><td><span id="playerName"></span></td>
            <tr><td>Situation: </td><td><span id="playerSituation"></span></td>
            <tr><td>Place: </td><td><span id="playerPlace"></span></td>
            <tr><td>Money: </td><td><span id="playerMoney"></span></td>
        </table>
    </div>
</div>

</body>
</html>

