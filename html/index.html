<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Dope</title>

    <style>
        .error {
            color: #8b0000;
            font-style: italic;
            font-weight: bold;
            text-align: center;
        }
        #capPositionX, #capPositionY {
            width: 20px;
        }
        .positionField {
            width: 30px;
        }
    </style>

    <script src="js/flapjax-2.1.js"></script>
    <script src="js/jquery-1.7.1.min.js"></script>
    <script>
        function loader() {
            function makeLoginRequest(name) {
                return {
                    url: '/login/', fields: {"playerName": JSON.stringify(name)},
                    request: "get", response: 'json'
                }
            }

            function makeActRequest(sessionId, option) {
                return {
                    url: '/play/', fields: {sessionId: JSON.stringify(sessionId), option: JSON.stringify(option)},
                    request: "get", response: 'json'
                }
            }

            function showLoginView() {
                $("#gameView").hide();
                $("#loginView").show();
            }

            function setupLoginView() {
                var loginNameB = extractValueB("loginName");
                var loginRequestsE = $E('loginButton', 'click')
                        .snapshotE(loginNameB)
                        .mapE(makeLoginRequest);
                var loginResponseE = getWebServiceObjectE(loginRequestsE);

                var loginDataE = loginResponseE
                        .filterE(function (r) {return r.OK != undefined})
                        .mapE(function (r) {return r.OK});
                var errorsE = loginResponseE
                        .filterE(function (r) {return r.Failure != undefined})
                        .mapE(function (r) {return showConstructor(r.Failure[0])});
                insertDomE(errorsE, "loginErrorText");
                $("#loginName").focus();
                return loginDataE;
            }

            function showConstructorName(c) {
                return Object.keys(c)[0];
            }

            function showConstructor(c) {
                var name = showConstructorName(c);
                var arguments = c[name];
                var argumentsText = "";
                $.each(arguments, function(index, a) {
                    argumentsText += "" + a + " "
                });
                var text = name + " " + argumentsText;
                return text.slice(0, text.length - 1);
            }

            function showPlayView(data) {
                $("#loginView").hide();
                $("#gameView").show();


                var capPositionX = extractValueB("capPositionX").liftB(parseInt);
                var capPositionY = extractValueB("capPositionY").liftB(parseInt);

                function makeCapRequest() {
                    var option = {TakeACap:[{Parameter:[{Position: [capPositionX.valueNow(), capPositionY.valueNow()]}]}]};
                    return makeActRequest(sessionIdB.valueNow(), option);
                }
                var capRequestsE = $E('takeACapButton', 'click')
                        .mapE(makeCapRequest);

                var responsesE = getWebServiceObjectE(capRequestsE);
                var okE = responsesE
                        .filterE(function (r) {return r.OK != undefined})
                        .mapE(function (r) {return r.OK});
                var failureE = responsesE
                        .filterE(function (r) {return r.Failure != undefined})
                        .mapE(function (r) {return showConstructor(r.Failure[0])});

                insertDomE(failureE, "playErrorText");

                var okB = okE.startsWith(data);
                var sessionIdB = okB.liftB(function (data) {return data[0]});
                var playerB = okB.liftB(function (data) {return data[1].PlayerIntrospection._player.Player});
                var optionsB = okB.liftB(function (data) {return data[2]});

                insertDomB(optionsB.liftB(JSON.stringify), "optionsText");

                var playerNameB = playerB.liftB(function (p) {return p._name});
                var playerSituationB = playerB.liftB(function (p) {return p._situation});
                var playerMoneyB = playerB.liftB(function (p) {return p._money});
                var playerPlaceB = playerB.liftB(function (p) {return p._place});
                var playerDrugBagsB = playerB.liftB(function (p) {return p._drugBags});

                insertDomB(playerNameB, "playerName");
                insertDomB(playerSituationB.liftB(JSON.stringify), "playerSituation");
                insertDomB(playerMoneyB.liftB(function (m) {return m + "$"}), "playerMoney");
                insertDomB(playerPlaceB.liftB(JSON.stringify), "playerPlace");

                playerDrugBagsB.liftB(function (bags) {
                    var table = $('#drugBagsTable');
                    table.empty();
                    $.each(bags, function(index, o) {
                        var bag = o.DrugBag;
                        var text = "" + bag._quantity + "g " + showConstructor(bag._drug) + " from " + bag._seller;
                        var row = $("<tr><td>" + text + "</td><td></td>");
                        table.append(row);
                    });
                });

                optionsB.liftB(function (options) {
                    console.dir(options);
                    optionInput(options);
                    return 0;
                });
            }

            var loginDataE = setupLoginView();
            showLoginView();

            loginDataE.mapE(function (data) {
                showPlayView(data);
            });

            function optionInput(options) {
                var list = $("#optionList");
                list.empty();
                $.each(options, function(index, option) {
                    var name = showConstructorName(option);
                    var arguments = option[name];
                    var label = $("<label>");
                    label.append($("<span>" + name + " </span>"))
                    $.each(arguments, function(index, a) {
                        if (a.Requested) {
                            var type = a.Requested[0];
                            if (type == "Int") {
                                var field = $("<input type='text'>");
                                label.append(field);
                            } else if (type == "Position") {
                                var fields = $("(<input class='positionField' type='text'>, <input class='positionField' type='text'>)");
                                label.append(fields);
                            }
                        } else {
                            label.append($("<span>" + a + "</span>"));
                        }
                    });
                    var line = $("<div>");
                    line.append(label);
                    list.append(line);
                })
            }
        }
    </script>

</head>
<body onload="loader()" id="body">

<div id="loginView">
    <fieldset>
        <legend>Login:</legend>
        <div><label>Name: <input id="loginName" type="text"></label></div>
        <div><button id="loginButton">Login</button></div>
        <div class="options"><span id="optionsText"></span></div>
        <div class="error"><span id="loginErrorText"></span></div>
    </fieldset>
</div>

<div id="gameView">
    <h1>World of Dope</h1>

    <fieldset>
        <legend>Act:</legend>
        <div id="optionList"></div>
        <div>Take a cap to
            (<input id="capPositionX" type="text">, <input id="capPositionY" type="text">)
            <button id="takeACapButton">Do it</button>
        </div>

        <div class="error"><span id="playErrorText"></span></div>
    </fieldset>

    <fieldset>
        <legend>You:</legend>
        <div id="playerView">
            <table id="playerTable">
                <tr><td>Name: </td><td><span id="playerName"></span></td>
                <tr><td>Situation: </td><td><span id="playerSituation"></span></td>
                <tr><td>Place: </td><td><span id="playerPlace"></span></td>
                <tr><td>Money: </td><td><span id="playerMoney"></span></td>
            </table>
        </div>
    </fieldset>

    <fieldset>
        <legend>Drugs:</legend>
        <div id="drugBagsView">
            <table id="drugBagsTable"></table>
        </div>
    </fieldset>
</div>

</body>
</html>

